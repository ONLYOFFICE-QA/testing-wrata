language: ruby
services:
  - docker
  - postgresql
rvm: 2.7
jobs:
  include:
    - stage: markdownlint
      script:
        - npm install -g markdownlint-cli
        - markdownlint *.md
    - stage: rubocop
      script:
        - bundle config set with 'development'
        - bundle install
        - bundle exec rubocop
    - stage: run tests
      script:
        - curl -sL https://deb.nodesource.com/setup_10.x | bash -
        - bundle install --without development
        - psql -c 'create database wrata_test;' -U postgres
        - RAILS_ENV=test bundle exec rake db:create db:migrate db:seed
        - bundle exec rake
    - stage: Default docker build
      script: docker build .
